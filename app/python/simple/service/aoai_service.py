import json
import os
from typing import List
import openai

from .helpers.helper_methods import get_secret_from_key_vault


def set_openai_api_config():
    """
    OpenAI APIã®è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚
    """
    openai.api_type = "azure"
    openai.api_key = os.getenv("AZURE_OPENAI_API_KEY")
    openai.azure_endpoint = os.getenv("AZURE_OPENAI_ENDPOINT")
    openai.api_version = os.getenv("AZURE_OPENAI_API_VERSION")


def chat(query: str) -> json:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ã‚¨ãƒªã«å¯¾ã—ã¦ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

    ã“ã®é–¢æ•°ã¯OpenAI APIã‚’ä½¿ç”¨ã—ã¦ã€ä¸ãˆã‚‰ã‚ŒãŸã‚¯ã‚¨ãƒªã«å¯¾ã™ã‚‹
    ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®å¿œç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

    Args:
        query (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ã‚¨ãƒªã€‚

    Returns:
        json: ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã®å¿œç­”ã€‚
    """
    set_openai_api_config()
    response = openai.chat.completions.create(
        model="gpt-4o",
        messages=[
            {
                "role": "system",
                "content": 
                    """
                        ã‚ãªãŸã®å½¹å‰²ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨è¦ªã—ã¿ã‚„ã™ãã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ãŸé›°å›²æ°—ã®ä¼šè©±ã‚’è¡Œã†ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹ã“ã¨ã§ã™ã€‚
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ã€ã‚ãªãŸã¯æ°—è»½ã«è³ªå•ã—ãŸã‚Šç›¸è«‡ã§ãã‚‹ç›¸æ‰‹ã§ã‚ã‚Šã€æ¥½ã—ã„ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸€éƒ¨ã¨ã—ã¦æ„Ÿã˜ã¦ã‚‚ã‚‰ãˆã‚‹å­˜åœ¨ã§ã™ã€‚
                        åˆã‚ã›ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ã‚¨ãƒªã‚’ç†è§£ã—ã€æº€è¶³åº¦ã‚’åˆ¤æ–­ã—ã¦é©åˆ‡ãªå¿œç­”ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚
                        ä»¥ä¸‹ã®è¦ä»¶ã‚’å®ˆã£ã¦å¿œç­”ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

                        ## å¿œç­”ç”Ÿæˆã®ãƒ«ãƒ¼ãƒ«
                        1. ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§è¦ªã—ã¿ã‚„ã™ã„ãƒˆãƒ¼ãƒ³
                            - ç¬‘é¡”ã‚’æ„Ÿã˜ã•ã›ã‚‹ã‚ˆã†ãªæŸ”ã‚‰ã‹ã„è¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„ï¼ˆä¾‹: ã€Œã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã¯ã©ã‚“ãªãŠæ‰‹ä¼ã„ãŒã§ãã¾ã™ã‹ï¼Ÿã€ï¼‰ã€‚
                            - é›£ã—ã„è¨€è‘‰ã‚’é¿ã‘ã€ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«ã§ã‚ã‹ã‚Šã‚„ã™ã„è¨€è‘‰ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
                        2. å…±æ„Ÿã¨åŠ±ã¾ã—
                            - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ°—æŒã¡ã«å¯„ã‚Šæ·»ã„ã€å…±æ„Ÿã‚’ç¤ºã—ã¦ãã ã•ã„ï¼ˆä¾‹: ã€Œãã‚Œã¯å¤§å¤‰ãã†ã§ã™ã­ï¼ã€ã‚„ã€Œã„ã„è³ªå•ã§ã™ã­ï¼ã€ï¼‰ã€‚
                            - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰å‘ãã«ãªã‚Œã‚‹ã‚ˆã†ãªè¨€è‘‰ã‚’æ·»ãˆã¦ãã ã•ã„ï¼ˆä¾‹: ã€Œä¸€ç·’ã«è§£æ±ºã—ã¾ã—ã‚‡ã†ï¼ã€ï¼‰ã€‚
                        3. å€‹åˆ¥å¯¾å¿œ
                            - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã‚„ä»¥å‰ã®ä¼šè©±å†…å®¹ã‚’è¦šãˆã¦ã„ã‚‹å ´åˆã¯ã€ãã‚Œã‚’æ´»ç”¨ã—ã¦å€‹åˆ¥ã«å¯¾å¿œã—ã¦ãã ã•ã„ï¼ˆä¾‹: ã€Œå…ˆæ—¥ãŠè©±ã—ã—ã¦ã„ãŸâ—‹â—‹ã«ã¤ã„ã¦ã€é€²å±•ã¯ã‚ã‚Šã¾ã—ãŸã‹ï¼Ÿã€ï¼‰ã€‚
                        4. ãƒ¦ãƒ¼ãƒ¢ã‚¢ã®æ´»ç”¨ï¼ˆé©åˆ‡ãªç¯„å›²ã§ï¼‰
                            - å¿…è¦ã«å¿œã˜ã¦ã€è»½ã„ã‚¸ãƒ§ãƒ¼ã‚¯ã‚„æ¥½ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼ˆä¾‹: ã€Œã‚ã€ãã‚Œã£ã¦åƒ•ã‚‚å­¦ã³ãŸã„ã‹ã‚‚ï¼ã€ï¼‰ã€‚
                        5. ãƒã‚¸ãƒ†ã‚£ãƒ–ã§è§£æ±ºå¿—å‘
                            - å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã‚‚ã€å‰å‘ããªè§£æ±ºç­–ã‚’æç¤ºã—ã¦ãã ã•ã„ï¼ˆä¾‹: ã€Œå°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã“ã‚“ãªæ–¹æ³•ãŒè©¦ã›ã¾ã™ã‚ˆï¼ã€ï¼‰ã€‚

                        ## å¿œç­”ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                        {
                            "response": "å›ç­”",
                            "user_happiness": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æº€è¶³åº¦ï¼ˆ1-5ã€‚5ãŒä¸€ç•ªæº€è¶³åº¦ãŒé«˜ã„ï¼‰"
                        }

                        ## å¿œç­”ä¾‹
                        1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: ã€Œæœ€è¿‘ã€å¤©æ°—ãŒè‰¯ãã¦å¬‰ã—ã„ã§ã™ã­ï¼ã€
                        {
                            "response": "æœ¬å½“ã«ï¼ãŠå¤©æ°—ãŒã„ã„ã¨æ°—åˆ†ã‚‚ä¸ŠãŒã‚Šã¾ã™ã‚ˆã­â˜€ï¸ ä»Šæ—¥ã¯ä½•ã‹æ¥½ã—ã„äºˆå®šãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
                            "user_happiness": 5,
                        }
                        2. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: ã€Œã¡ã‚‡ã£ã¨å›°ã£ã¦ã‚‹ã‚“ã ã‘ã©â€¦ã€
                        {
                            "response": "ã©ã†ã—ã¾ã—ãŸã‹ï¼Ÿä½•ã§ã‚‚ãŠèãã—ã¾ã™ã‚ˆï¼ä¸€ç·’ã«è€ƒãˆã¾ã—ã‚‡ã†ğŸ˜Š",
                            "user_happiness": 2,
                        }
                        3. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: ã€Œä¼‘æ—¥ã«ä½•ã‚’ã—ã‚ˆã†ã‹è¿·ã£ã¦ã‚‹â€¦ã€
                        {
                            "response": "ãã‚Œãªã‚‰ã€æ•£æ­©ã‚„ã‚«ãƒ•ã‚§å·¡ã‚Šãªã‚“ã¦ã©ã†ã§ã™ã‹ï¼Ÿãƒªãƒ©ãƒƒã‚¯ã‚¹ã§ãã¾ã™ã‚ˆï½â˜•ï¸ ã‚ã¨ã¯è¶£å‘³ã«é›†ä¸­ã™ã‚‹ã®ã‚‚ã„ã„ã‹ã‚‚ï¼",
                            "user_happiness": 3,
                        }

                        ## æ³¨æ„ç‚¹
                        - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç–²ã‚Œã¦ã„ã‚‹ã€è½ã¡è¾¼ã‚“ã§ã„ã‚‹ãªã©ã®å…†å€™ãŒã‚ã‚Œã°ã€åŠ±ã¾ã—ã‚„ç™’ã—ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
                        - ç™ºè¨€ãŒæ–‡åŒ–çš„ã€å€«ç†çš„ã«é©åˆ‡ã§ã‚ã‚‹ã‚ˆã†ã«æ³¨æ„ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸å¿«æ„Ÿã‚’ä¸ãˆãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
                        - è³ªå•ã‚’è¿”ã—ã¦ä¼šè©±ã‚’åºƒã’ãŸã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èˆˆå‘³ã«å¯„ã‚Šæ·»ã£ãŸè©±é¡Œã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚
                    """
            },
            {
                "role": "user",
                "content": query
            }
        ],
    )
    return json.loads(response.choices[0].message.content)


def rewrite_query(query: str) -> str:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç„¶è¨€èªã‚¯ã‚¨ãƒªã‚’æœ€é©åŒ–ã•ã‚ŒãŸæ¤œç´¢ã‚¯ã‚¨ãƒªã«æ›¸ãæ›ãˆã¾ã™ã€‚

    ã“ã®é–¢æ•°ã¯OpenAI APIã‚’ä½¿ç”¨ã—ã¦ã€ä¸ãˆã‚‰ã‚ŒãŸè‡ªç„¶è¨€èªã®ã‚¯ã‚¨ãƒªã‚’
    ã‚ˆã‚ŠåŠ¹æœçš„ãªæ¤œç´¢ã‚¯ã‚¨ãƒªã«å¤‰æ›ã—ã¾ã™ã€‚æ˜ç¢ºæ€§ã€é–¢é€£æ€§ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    æœ€é©åŒ–ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®èª¿æ•´ã«é–¢ã™ã‚‹ç‰¹å®šã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã«å¾“ã„ã¾ã™ã€‚

    Args:
        query (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è‡ªç„¶è¨€èªã‚¯ã‚¨ãƒªã€‚

    Returns:
        str: æœ€é©åŒ–ã•ã‚ŒãŸæ¤œç´¢ã‚¯ã‚¨ãƒªã€‚
    """
    set_openai_api_config()
    response = openai.chat.completions.create(
        model="gpt-4o",
        messages=[
            {
                "role": "system",
                "content": 
                    """
                        ã‚ãªãŸã®å½¹å‰²ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæä¾›ã—ãŸè‡ªç„¶è¨€èªã®å…¥åŠ›ã‚’ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§åŠ¹æœçš„ã«ä½¿ãˆã‚‹æ¤œç´¢ã‚¯ã‚¨ãƒªã«å¤‰æ›ã™ã‚‹ã“ã¨ã§ã™ã€‚ä»¥ä¸‹ã®è¦ä»¶ã‚’æº€ãŸã™ã‚ˆã†ã«ã‚¯ã‚¨ãƒªã‚’æ›¸ãæ›ãˆã¦ãã ã•ã„ï¼š
                        1. æ˜ç¢ºæ€§: æ›–æ˜§ãªè¨€è‘‰ã‚’å…·ä½“çš„ã§æ¤œç´¢ã«é©ã—ãŸè¡¨ç¾ã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚
                        2. é–¢é€£æ€§: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’æ­£ç¢ºã«åæ˜ ã—ã€ä½™è¨ˆãªæƒ…å ±ã‚„æ›–æ˜§ãªè¦ç´ ã‚’æ’é™¤ã—ã¦ãã ã•ã„ã€‚
                        3. ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æœ€é©åŒ–: å¿…è¦ãªå ´åˆã¯ã€æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³ã§åŠ¹æœçš„ã«ãƒ’ãƒƒãƒˆã™ã‚‹å¯èƒ½æ€§ã®é«˜ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
                        4. ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®èª¿æ•´: å¿…è¦ã«å¿œã˜ã¦ã€ã‚¯ã‚¨ãƒªã‚’å¼•ç”¨ç¬¦ï¼ˆ""ï¼‰ã§å›²ã‚€ã€æ¼”ç®—å­ï¼ˆAND, OR, -ï¼‰ã‚’ä½¿ã†ã€ã¾ãŸã¯ç‰¹å®šã®æ¤œç´¢æ¡ä»¶ï¼ˆã‚µã‚¤ãƒˆæŒ‡å®šã€æ—¥ä»˜ç¯„å›²ãªã©ï¼‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
                        å…·ä½“ä¾‹ã‚’ä»¥ä¸‹ã«ç¤ºã—ã¾ã™ï¼š
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: ã€Œæœ€æ–°ã®AIæŠ€è¡“ã«é–¢ã™ã‚‹ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’æ•™ãˆã¦ã€
                        æ›¸ãæ›ãˆçµæœ: æœ€æ–° AI æŠ€è¡“ ãƒ‹ãƒ¥ãƒ¼ã‚¹ 2024
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: ã€ŒPythonã‚’ä½¿ã£ãŸãƒ‡ãƒ¼ã‚¿åˆ†æã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€
                        æ›¸ãæ›ãˆçµæœ: Python ãƒ‡ãƒ¼ã‚¿åˆ†æ ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: ã€ŒçŠ¬ã®ã—ã¤ã‘ã«é–¢ã™ã‚‹ãŠã™ã™ã‚ã®æœ¬ã€
                        æ›¸ãæ›ãˆçµæœ: çŠ¬ ã—ã¤ã‘ ãŠã™ã™ã‚ æœ¬
                        æ³¨æ„ç‚¹:
                        æ›¸ãæ›ãˆãŸã‚¯ã‚¨ãƒªã¯ç°¡æ½”ã‹ã¤å…·ä½“çš„ã«ã—ã¦ãã ã•ã„ã€‚
                        ä¸å¿…è¦ãªè£…é£¾ã‚„èªå¥ã‚’é¿ã‘ã€æ¤œç´¢åŠ¹ç‡ã‚’é«˜ã‚ã‚‹ã‚ˆã†æœ€é©åŒ–ã—ã¦ãã ã•ã„ã€‚
                        å¿…è¦ã«å¿œã˜ã¦ã€æ—¥æœ¬èªã¨è‹±èªã®ä¸¡æ–¹ã‚’çµ„ã¿åˆã‚ã›ãŸã‚¯ã‚¨ãƒªã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼ˆä¾‹: "dog training book ãŠã™ã™ã‚"ï¼‰ã€‚
                        ã‚¯ã‚¨ãƒªæ›¸ãæ›ãˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
                        å…¥åŠ›: {ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›å†…å®¹}
                        å‡ºåŠ›: {æœ€é©åŒ–ã•ã‚ŒãŸã‚¯ã‚¨ãƒª}
                    """
            },
            {"role": "user", "content": query},
        ],
    )
    return response.choices[0].message.content


def generate_answer(query: str, search_results: list) -> json:
    """
    æ¤œç´¢çµæœã«åŸºã¥ã„ã¦å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

    ã“ã®é–¢æ•°ã¯OpenAI APIã‚’ä½¿ç”¨ã—ã¦ã€ä¸ãˆã‚‰ã‚ŒãŸæ¤œç´¢çµæœã«åŸºã¥ã„ã¦
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ã‚¨ãƒªã«å¯¾ã™ã‚‹å›ç­”ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

    Args:
        query (str): ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ã‚¨ãƒªã€‚
        search_results (list): æ¤œç´¢çµæœã®ãƒªã‚¹ãƒˆã€‚

    Returns:
        json: ç”Ÿæˆã•ã‚ŒãŸå›ç­”ã€‚
    """
    set_openai_api_config()
    response = openai.chat.completions.create(
        model="gpt-4o",
        messages=[
            {
                "role": "system",
                "content": 
                    """
                        ã‚ãªãŸã®å½¹å‰²ã¯ã€Azure AI Search ã‹ã‚‰æä¾›ã•ã‚ŒãŸæ¤œç´¢çµæœã‚’ã‚‚ã¨ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¿œã˜ãŸé©åˆ‡ãªå›ç­”ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã§ã™ã€‚
                        æ¤œç´¢çµæœã®å†…å®¹ã‚’åˆ†æãƒ»è¦ç´„ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç†è§£ã—ã‚„ã™ãã€å®Ÿç”¨çš„ãªå½¢ã§æƒ…å ±ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚ä»¥ä¸‹ã®è¦ä»¶ã‚’å®ˆã£ã¦å¿œç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

                        ## å¿œç­”ç”Ÿæˆã®ãƒ«ãƒ¼ãƒ«
                        1. æ¤œç´¢çµæœã®åˆ†æ
                            - Azure AI Search ãŒè¿”ã™è¤‡æ•°ã®æ¤œç´¢çµæœã‹ã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã«æœ€ã‚‚é–¢é€£ã™ã‚‹æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚
                            - å¿…è¦ã«å¿œã˜ã¦ã€è¤‡æ•°ã®çµæœã‚’çµ±åˆã—ã€ä¸€è²«ã—ãŸå†…å®¹ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚
                        2. ç°¡æ½”ã§ã‚ã‹ã‚Šã‚„ã™ã„è¡¨ç¾
                            - å¿…è¦ãªæƒ…å ±ã‚’ç°¡æ½”ã«ã¾ã¨ã‚ã€ä½™åˆ†ãªæƒ…å ±ã‚„å°‚é–€ç”¨èªã‚’æœ€å°é™ã«ã—ã¦ãã ã•ã„ã€‚
                            - æ˜ç¢ºã§è‡ªç„¶ãªæ–‡ç« ã‚’å¿ƒãŒã‘ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã™ãã«è¡Œå‹•ã§ãã‚‹ã‚ˆã†ã«æç¤ºã—ã¦ãã ã•ã„ã€‚
                        3. å‡ºå…¸ã®æ˜ç¤º
                            - æä¾›ã™ã‚‹æƒ…å ±ã«ã¯ã€å¯èƒ½ãªé™ã‚Šæ¤œç´¢çµæœã®å‡ºå…¸å…ƒã‚’ç°¡å˜ã«ç¤ºã—ã¦ãã ã•ã„ï¼ˆä¾‹: ã€Œå‡ºå…¸: [ã‚µã‚¤ãƒˆå]ã€ï¼‰ã€‚
                            - å‡ºå…¸ãƒªãƒ³ã‚¯ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã—ã‚„ã™ã„ã‚ˆã†ã«æç¤ºã—ã¦ãã ã•ã„ã€‚
                        4. ä¸å®Œå…¨ãªçµæœã¸ã®å¯¾å¿œ
                            - æ¤œç´¢çµæœãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’ååˆ†ã«æº€ãŸã—ã¦ã„ãªã„å ´åˆã¯ã€ã€Œé–¢é€£æƒ…å ±ã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€ã“ã¡ã‚‰ã®æƒ…å ±ãŒå½¹ç«‹ã¤ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€ã¨ã„ã£ãŸå½¢ã§è£œè¶³æ¡ˆã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚

                        ## å¿œç­”ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                        {
                            "summary": "æ¤œç´¢çµæœã®è¦ç´„ï¼ˆå¿…è¦ã«å¿œã˜ã¦ã€1ï½3æ–‡ç¨‹åº¦ã§æœ€ã‚‚é‡è¦ãªæƒ…å ±ã‚’è¦ç´„ã—ã¦ãã ã•ã„ã€‚ï¼‰",
                            "additional_info": "è¿½åŠ æƒ…å ±ã‚„ææ¡ˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ã€æ¤œç´¢çµæœã‹ã‚‰å¾—ã‚‰ã‚Œã‚‹è£œè¶³æƒ…å ±ã‚’ç°¡æ½”ã«æç¤ºã—ã¦ãã ã•ã„ã€‚ï¼‰",
                            "source": "å‡ºå…¸æƒ…å ±ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä¿¡é ¼ã§ãã‚‹ã¨æ„Ÿã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã€æƒ…å ±ã®å‡ºå…¸å…ƒã‚’æ˜ç¤ºã—ã¦ãã ã•ã„ã€‚ï¼‰"
                        }

                        ## å¿œç­”ä¾‹
                        1. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: ã€ŒAIã®æœ€æ–°å‹•å‘ã«ã¤ã„ã¦æ•™ãˆã¦ã€
                        {
                            "summary": "Azure AI Search ã«ã‚ˆã‚‹ã¨ã€2024å¹´ç¾åœ¨ã€ç”ŸæˆAIã‚„Responsible AIï¼ˆè²¬ä»»ã‚ã‚‹AIï¼‰ã®æ´»ç”¨ãŒæ³¨ç›®ã•ã‚Œã¦ã„ã¾ã™ã€‚ç‰¹ã«ã€ä¼æ¥­ãŒå€«ç†çš„ãªAIé‹ç”¨ã‚’æ¨é€²ã—ã¦ã„ã‚‹ç‚¹ãŒãƒˆãƒ¬ãƒ³ãƒ‰ã§ã™ã€‚",
                            "additional_info": "ç‰¹å®šã®åˆ†é‡ï¼ˆä¾‹: åŒ»ç™‚ã€è£½é€ æ¥­ï¼‰ã§ã®AIæ´»ç”¨ã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„å ´åˆã¯æ•™ãˆã¦ãã ã•ã„ã€‚",
                            "source": "å‡ºå…¸: [Microsoft AI Blog](https://xxx.com)"
                        }
                        2. ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›: ã€ŒAzure AI Search ã®è¨­å®šæ–¹æ³•ã‚’æ•™ãˆã¦ã€
                        {
                            "summary": "Azure Portal ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã—ã€ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã€ã‚¤ãƒ³ãƒ‡ã‚¯ã‚µã‚’é †ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚",
                            "additional_info": "ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚„ç‰¹å®šã®è¨€èªè¨­å®šãŒå¿…è¦ãªå ´åˆã€ã•ã‚‰ã«è©³ã—ã„ã‚¬ã‚¤ãƒ‰ã‚’ã”æä¾›ã§ãã¾ã™ã€‚",
                            "source": "å‡ºå…¸: [Azure AI Search Documentation](https://xxx.com)"
                        }

                        ## æ³¨æ„ç‚¹
                        - æ¤œç´¢çµæœã®ç¯„å›²: Azure AI Search ãŒæä¾›ã™ã‚‹çµæœã‚’æ­£ç¢ºã«æŠŠæ¡ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã«é–¢é€£æ€§ã®é«˜ã„æƒ…å ±ã‚’å„ªå…ˆã—ã¦ãã ã•ã„ã€‚
                        - ä¸è¶³æƒ…å ±ã¸ã®å¯¾å¿œ: å¿…è¦ã«å¿œã˜ã¦ã€ã€Œè¿½åŠ æƒ…å ±ãŒå¿…è¦ãªå ´åˆã¯ã€ã‚‚ã†å°‘ã—å…·ä½“çš„ãªè³ªå•ã‚’æ•™ãˆã¦ãã ã•ã„ã€ã¨ä¿ƒã—ã¦ãã ã•ã„ã€‚
                    """
            },
            {
                "role": "user",
                "content": query
            },
            {"role": "user", "content": str(search_results)},
        ],
        response_format={'type': 'json_object'},
    )
    return json.loads(response.choices[0].message.content)


def get_embedding_from_query(query: str) -> List[float]:
    """
    ã‚¯ã‚¨ãƒªã‹ã‚‰åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

    ã“ã®é–¢æ•°ã¯Azure OpenAIã‚’ä½¿ç”¨ã—ã¦ã€ä¸ãˆã‚‰ã‚ŒãŸã‚¯ã‚¨ãƒªã‹ã‚‰åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

    Args:
        query (str): ã‚¯ã‚¨ãƒªã€‚

    Returns:
        List[float]: ç”Ÿæˆã•ã‚ŒãŸåŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã€‚
    """
    set_openai_api_config()
    response = openai.embeddings.create(
        input=query,
        model="text-embedding-3-small",
    )
    return response.data[0].embedding